<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - KhataBook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
      [data-theme="dark"] {
        --bg-primary: #1a202c;
        --bg-secondary: #2d3748;
        --text-primary: #f7fafc;
        --text-secondary: #e2e8f0;
        --border-color: #4a5568;
      }
      [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f7fafc;
        --text-primary: #1a202c;
        --text-secondary: #4a5568;
        --border-color: #e2e8f0;
      }
      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }
      .bg-custom-white {
        background-color: var(--bg-primary);
      }
      .bg-custom-gray {
        background-color: var(--bg-secondary);
      }
      .text-custom-primary {
        color: var(--text-primary);
      }
      .text-custom-secondary {
        color: var(--text-secondary);
      }
      .border-custom {
        border-color: var(--border-color);
      }
    </style>
  </head>
  <body class="bg-custom-white">
    <%- include('partials/header', { 
      title: 'Dashboard',
      isLoggedIn: true,
      pageTitle: 'Your Dashboard',
      currentPath: '/dashboard'
    }) %>

    <!-- Filter Controls -->
    <div class="card p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="flex items-center">
          <label for="filter" class="mr-2 text-sm font-medium text-custom-secondary whitespace-nowrap">Sort by:</label>
          <select id="filter" class="form-control bg-custom-white text-custom-primary border border-custom">
            <option value="latest">Latest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>

        <div class="flex flex-col sm:flex-row items-start sm:items-center">
          <label for="dateFilter" class="mr-2 text-sm font-medium text-custom-secondary mb-1 sm:mb-0">Date Range:</label>
          <div class="flex flex-col sm:flex-row gap-2 w-full">
            <input type="date" id="startDate" class="form-control bg-custom-white text-custom-primary border border-custom" />
            <span class="hidden sm:block text-custom-secondary mx-1">to</span>
            <input type="date" id="endDate" class="form-control bg-custom-white text-custom-primary border border-custom" />
          </div>
        </div>

        <div class="flex justify-end">
          <button onclick="applyFilters()" class="btn-primary px-4 py-2 rounded-md">
            Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Hisab Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <% if (hisabs && hisabs.length > 0) { %>
        <% hisabs.forEach(hisab => { %>
          <div class="card border border-custom rounded-lg p-6 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 hisab-card">
            <div class="flex flex-col mb-4">
              <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-custom-primary"><%= hisab.name %></h2>
                <div class="flex gap-2">
                  <% if(hisab.isEncrypted) { %>
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                      <i class="fas fa-lock text-green-600 mr-1"></i>
                    </span>
                  <% } %>
                  <% if(hisab.isShareable) { %>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                      <i class="fas fa-share-alt text-blue-600 mr-1"></i>
                    </span>
                  <% } %>
                </div>
              </div>
              <div class="text-custom-secondary text-sm mb-3">
                <i class="far fa-calendar-alt mr-1"></i>
                <span class="hisab-date"><%= new Date(hisab.createdAt).toLocaleDateString() %></span>
              </div>
            </div>
            
            <div class="bg-custom-gray p-4 rounded-lg mb-4">
              <p class="text-custom-primary line-clamp-3"><%= hisab.description %></p>
            </div>

            <div class="flex justify-between items-center mt-auto">
              <div class="text-sm text-custom-secondary">
                <%= hisab.transactions ? hisab.transactions.length : 0 %> transactions
              </div>
              <a href="/viewHisab/<%= hisab._id %>" class="btn-primary px-4 py-2 rounded-md flex items-center group">
                <span>View</span>
                <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform duration-200"></i>
              </a>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-12">
          <div class="bg-custom-gray p-8 rounded-lg">
            <div class="text-5xl text-blue-600 mb-4">
              <i class="fas fa-clipboard-list"></i>
            </div>
            <h3 class="text-xl font-semibold text-custom-primary mb-2">No Hisabs Found</h3>
            <p class="text-custom-secondary mb-6">You haven't created any hisabs yet. Create your first one to get started!</p>
            <a href="/createHisab" class="btn-primary px-6 py-3 rounded-md inline-flex items-center">
              <i class="fas fa-plus mr-2"></i>
              <span>Create Your First Hisab</span>
            </a>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Create Hisab Button (Fixed) -->
    <% if (hisabs && hisabs.length > 0) { %>
      <div class="fixed bottom-6 right-6">
        <a href="/createHisab" class="btn-primary h-14 w-14 rounded-full flex items-center justify-center shadow-lg">
          <i class="fas fa-plus text-xl"></i>
        </a>
      </div>
    <% } %>

    <%- include('partials/footer', { 
      isLoggedIn: true,
      scripts: `
        // Filter Functionality
        function applyFilters() {
          const sortBy = document.getElementById('filter').value;
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;

          const cards = document.querySelectorAll('.hisab-card');
          const cardsArray = Array.from(cards);

          // Sort cards
          cardsArray.sort((a, b) => {
            const dateA = new Date(a.querySelector('.hisab-date').textContent);
            const dateB = new Date(b.querySelector('.hisab-date').textContent);
            return sortBy === 'latest' ? dateB - dateA : dateA - dateB;
          });

          // Filter by date range
          const filteredCards = cardsArray.filter(card => {
            const cardDate = new Date(card.querySelector('.hisab-date').textContent);
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;

            if (start && cardDate < start) return false;
            if (end && cardDate > end) return false;
            return true;
          });

          // Clear and re-append cards
          const container = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3');
          container.innerHTML = '';
          
          if (filteredCards.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'col-span-1 md:col-span-2 lg:col-span-3 text-center py-12';
            noResults.innerHTML = \`
              <div class="bg-custom-gray p-8 rounded-lg">
                <div class="text-5xl text-blue-600 mb-4">
                  <i class="fas fa-search"></i>
                </div>
                <h3 class="text-xl font-semibold text-custom-primary mb-2">No Matching Results</h3>
                <p class="text-custom-secondary mb-6">Try adjusting your filters to see more results.</p>
                <button onclick="resetFilters()" class="btn-secondary px-6 py-3 rounded-md">
                  Reset Filters
                </button>
              </div>
            \`;
            container.appendChild(noResults);
          } else {
            filteredCards.forEach(card => container.appendChild(card));
          }
        }

        function resetFilters() {
          document.getElementById('filter').value = 'latest';
          document.getElementById('startDate').value = '';
          document.getElementById('endDate').value = '';
          applyFilters();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
          applyFilters();
        });
      `
    }) %>
  </body>
</html>
