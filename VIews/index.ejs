<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - KhataBook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
      [data-theme="dark"] {
        --bg-primary: #1a202c;
        --bg-secondary: #2d3748;
        --text-primary: #f7fafc;
        --text-secondary: #e2e8f0;
        --border-color: #4a5568;
      }
      [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f7fafc;
        --text-primary: #1a202c;
        --text-secondary: #4a5568;
        --border-color: #e2e8f0;
      }
      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }
      .bg-custom-white {
        background-color: var(--bg-primary);
      }
      .bg-custom-gray {
        background-color: var(--bg-secondary);
      }
      .text-custom-primary {
        color: var(--text-primary);
      }
      .text-custom-secondary {
        color: var(--text-secondary);
      }
      .border-custom {
        border-color: var(--border-color);
      }
    </style>
  </head>
  <body class="bg-custom-white">
    <nav class="bg-custom-white shadow-md border-b border-custom">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <a href="/dashboard" class="text-2xl font-bold text-blue-600">
              <i class="fas fa-book-open mr-2"></i>KhataBook
            </a>
          </div>
          <div class="flex items-center gap-4">
            <button id="themeToggle" class="theme-toggle p-2 rounded-full hover:bg-custom-gray">
              <i class="fas fa-moon text-custom-primary"></i>
            </button>
            <div class="flex items-center gap-3">
              <a href="/profile" class="btn-secondary px-4 py-2 rounded-md">Profile</a>
              <a href="/logout" class="btn-primary px-4 py-2 rounded-md">LogOut</a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto">
      <div class="flex flex-col md:flex-row gap-4 my-8 bg-custom-gray p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-center">
          <label for="filter" class="mr-2 text-custom-secondary font-medium">Sort by:</label>
          <select id="filter" class="p-2 border border-custom rounded-md bg-custom-white text-custom-primary hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="latest">Latest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>

        <div class="flex items-center">
          <label for="dateFilter" class="mr-2 text-custom-secondary font-medium">Date Range:</label>
          <div class="flex gap-2">
            <input type="date" id="startDate" class="p-2 border border-custom rounded-md bg-custom-white text-custom-primary hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <span class="text-custom-secondary mt-2 font-bold">to</span>
            <input type="date" id="endDate" class="p-2 border border-custom rounded-md bg-custom-white text-custom-primary hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>

        <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 ease-in-out">
          Apply Filters
        </button>
      </div>
    </div>

    <!-- all khatas of the user -->
    <div class="flex flex-row flex-wrap gap-4 justify-center mb-6">
      <% if (hisabs && hisabs.length > 0) { %>
        <% hisabs.forEach(hisab => { %>
          <div class="bg-custom-white p-6 rounded-xl shadow-lg hover:shadow-2xl w-1/3 transition-all duration-300 border border-custom transform hover:-translate-y-1 hisab-card">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-custom-primary mb-4 md:mb-0"><%= hisab.name %></h2>
              <div class="flex items-center gap-4">
                <% if(hisab.isEncrypted) { %>
                  <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium flex items-center">
                    <i class="fas fa-lock text-green-600 mr-2"></i>
                    Encrypted
                  </span>
                <% } %>
                <% if(hisab.isShareable) { %>
                  <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium flex items-center">
                    <i class="fas fa-share-alt text-blue-600 mr-2"></i>
                    Shareable
                  </span>
                <% } %>
                <div class="text-custom-secondary font-medium text-sm">
                  <i class="far fa-calendar-alt mr-2"></i>
                  <span class="hisab-date"><%= hisab.createdAt.toLocaleDateString() %></span>
                </div>
              </div>
            </div>
            
            <div class="bg-custom-gray p-5 rounded-lg mb-6">
              <p class="text-custom-primary leading-relaxed text-lg">
                <%= hisab.description %>
              </p>
            </div>

            <div class="flex justify-between items-center">
              <div class="text-sm text-custom-secondary">
                Created <%= hisab.createdAt.toLocaleTimeString() %>
              </div>
              <a href="/viewHisab/<%= hisab._id %>">
                <button class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out flex items-center group">
                  <span class="font-medium">View Details</span>
                  <i class="fas fa-arrow-right ml-3 transform group-hover:translate-x-2 transition-transform duration-300"></i>
                </button>
              </a>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="text-center w-full py-8">
          <p class="text-custom-secondary text-lg">No hisabs found. Create your first hisab!</p>
        </div>
      <% } %>
    </div>
   
    <div class="text-center">
      <a href="/createHisab">
        <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition duration-200 ease-in-out flex items-center group mx-auto">
          <span>Create New Hisab</span>
          <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform duration-200"></i>
        </button>
      </a>
    </div>

    <script>
      // Theme Toggle
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle.querySelector('i');
      
      // Check for saved theme preference
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });

      function updateThemeIcon(theme) {
        themeIcon.className = theme === 'light' ? 'fas fa-moon text-custom-primary' : 'fas fa-sun text-custom-primary';
      }

      // Filter Functionality
      function applyFilters() {
        const sortBy = document.getElementById('filter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const cards = document.querySelectorAll('.hisab-card');
        const cardsArray = Array.from(cards);

        // Sort cards
        cardsArray.sort((a, b) => {
          const dateA = new Date(a.querySelector('.hisab-date').textContent);
          const dateB = new Date(b.querySelector('.hisab-date').textContent);
          return sortBy === 'latest' ? dateB - dateA : dateA - dateB;
        });

        // Filter by date range
        const filteredCards = cardsArray.filter(card => {
          const cardDate = new Date(card.querySelector('.hisab-date').textContent);
          const start = startDate ? new Date(startDate) : null;
          const end = endDate ? new Date(endDate) : null;

          if (start && cardDate < start) return false;
          if (end && cardDate > end) return false;
          return true;
        });

        // Clear and re-append cards
        const container = document.querySelector('.flex.flex-row.flex-wrap');
        container.innerHTML = '';
        filteredCards.forEach(card => container.appendChild(card));
      }

      // Add event listeners
      document.getElementById('filter').addEventListener('change', applyFilters);
      document.getElementById('startDate').addEventListener('change', applyFilters);
      document.getElementById('endDate').addEventListener('change', applyFilters);
    </script>
  </body>
</html>
